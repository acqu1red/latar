<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç CORS –≤ –±—Ä–∞—É–∑–µ—Ä–µ</title>
</head>
<body>
    <h1>–¢–µ—Å—Ç CORS –≤ –±—Ä–∞—É–∑–µ—Ä–µ</h1>
    
    <div>
        <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Health Check</h2>
        <button onclick="testHealth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Health Check</button>
        <div id="health-result"></div>
    </div>
    
    <div>
        <h2>2. –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="testGeneration()">–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
        <div id="generation-result"></div>
        <div id="image-result"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://competitive-camellia-latar-a11ca532.koyeb.app';
        
        async function testHealth() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.innerHTML = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
            
            try {
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º health check –∑–∞–ø—Ä–æ—Å...');
                const response = await fetch(`${API_BASE_URL}/healthz`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include'
                });
                
                console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status, response.statusText);
                console.log('üì• Headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `‚úÖ Health Check: ${JSON.stringify(data)}`;
                } else {
                    resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }
        
        async function testGeneration() {
            const fileInput = document.getElementById('imageInput');
            const resultDiv = document.getElementById('generation-result');
            const imageDiv = document.getElementById('image-result');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                return;
            }
            
            resultDiv.innerHTML = '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º...';
            imageDiv.innerHTML = '';
            
            try {
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é...');
                console.log('üì§ URL:', `${API_BASE_URL}/api/generate-photo`);
                console.log('üì§ Origin:', window.location.origin);
                
                const response = await fetch(`${API_BASE_URL}/api/generate-photo`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    credentials: 'include'
                });
                
                console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status, response.statusText);
                console.log('üì• Headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const blob = await response.blob();
                    console.log('üì∑ –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', blob.size, '–±–∞–π—Ç');
                    
                    const imageUrl = URL.createObjectURL(blob);
                    imageDiv.innerHTML = `<img src="${imageUrl}" style="max-width: 500px; border: 1px solid #ccc;">`;
                    resultDiv.innerHTML = `‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –†–∞–∑–º–µ—Ä: ${blob.size} –±–∞–π—Ç`;
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå –û—à–∏–±–∫–∞:', errorText);
                    resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${errorText}`;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`;
            }
        }
    </script>
</body>
</html>
