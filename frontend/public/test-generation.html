<!DOCTYPE html>
<html>
<head>
    <title>Test Generation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input[type="file"] { margin: 10px 0; }
        #result { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–æ–≤</h1>
    
    <div class="test-section">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É</h3>
        <button onclick="testBackendConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        <div id="connection-result"></div>
    </div>

    <div class="test-section">
        <h3>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞</h3>
        <button onclick="testApiKey()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á</button>
        <div id="apikey-result"></div>
    </div>

    <div class="test-section">
        <h3>3. –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞</h3>
        <input type="file" id="imageFile" accept="image/*" />
        <button onclick="testGeneration()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</button>
        <div id="generation-result"></div>
    </div>

    <div id="result"></div>

    <script>
        async function testBackendConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<p class="info">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>';
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π URL –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
                const response = await fetch('/api/healthz');
                const data = await response.json();
                resultDiv.innerHTML = '<p class="success">‚úÖ –ë—ç–∫–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç: ' + JSON.stringify(data) + '</p>';
            } catch (error) {
                resultDiv.innerHTML = '<p class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message + '</p>';
                console.error('Connection error:', error);
            }
        }

        async function testApiKey() {
            const resultDiv = document.getElementById('apikey-result');
            resultDiv.innerHTML = '<p class="info">–ü—Ä–æ–≤–µ—Ä—è–µ–º API –∫–ª—é—á...</p>';
            
            try {
                const response = await fetch('/api/test-comet-api');
                const data = await response.json();
                if (data.success) {
                    resultDiv.innerHTML = '<p class="success">‚úÖ API –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç: ' + data.message + '</p>';
                } else {
                    resultDiv.innerHTML = '<p class="error">‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º: ' + data.error + '</p>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<p class="error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ API: ' + error.message + '</p>';
                console.error('API key test error:', error);
            }
        }

        async function testGeneration() {
            const fileInput = document.getElementById('imageFile');
            const resultDiv = document.getElementById('generation-result');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<p class="error">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="info">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–ª–∞–Ω... (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30-60 —Å–µ–∫—É–Ω–¥)</p>';
            
            try {
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                formData.append('mode', 'withoutFurniture');

                const response = await fetch('/api/generate-technical-plan', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }

                // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const imageBlob = await response.blob();
                const imageUrl = URL.createObjectURL(imageBlob);
                
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</p>
                    <img src="${imageUrl}" style="max-width: 100%; height: auto; margin-top: 10px;" alt="Generated Plan" />
                `;
            } catch (error) {
                resultDiv.innerHTML = '<p class="error">‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message + '</p>';
            }
        }
    </script>
</body>
</html>
