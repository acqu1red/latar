# Обновление системы анализа мебели

## Что изменилось

Система анализа фотографий помещений была полностью переработана для более точного и контролируемого распознавания мебели.

### 1. Создана расширенная база данных мебели

Добавлен файл `backend/src/furnitureDatabase.mjs` со строгими JSON-определениями для всех типов мебели:

#### Основные категории:
- **Спальная мебель**: кровати (односпальные, двуспальные, king-size), шкафы, прикроватные тумбы, комоды
- **Гостиная**: диваны (прямые, угловые, модульные), кресла, журнальные столики, ТВ-тумбы, книжные шкафы
- **Кухня и столовая**: обеденные столы, стулья, кухонные гарнитуры (Г-, П-, прямые), кухонные острова
- **Бытовая техника**: холодильники, стиральные машины, посудомойки, духовки, микроволновки
- **Сантехника**: ванны, душевые кабины, унитазы, раковины, биде
- **Офисная мебель**: компьютерные и письменные столы, офисные кресла, картотечные шкафы
- **Детская мебель**: кроватки, пеленальные столики, ящики для игрушек
- **Системы хранения**: полки, шкафы-пеналы, бельевые шкафы
- **Декоративные элементы**: торшеры, настольные лампы, подставки для растений, пуфы
- **Техника и электроника**: телевизоры, компьютеры, мониторы, принтеры
- **Балконная мебель**: столики, стулья, шкафы для балкона, сушилки

### 2. Улучшенный анализ координат

GPT теперь получает данные о геометрии помещения из конструктора:
- Точные координаты и размеры помещения
- Расположение дверей и окон
- Инструкции по размещению мебели относительно стен

### 3. Контролируемое распознавание

**Ключевые изменения:**
- GPT ищет ТОЛЬКО мебель из предопределенного списка для каждого типа помещения
- Если мебель не видна четко на фото - она не добавляется в результат
- Система не "додумывает" объекты, которых нет на фотографиях
- Координаты размещаются с учетом дверей и окон

## Примеры JSON-кодов мебели

### Кровать
```json
{
  "type": "bed",
  "subtype": "double",
  "position": { "x": 0, "y": 0 },
  "size": { "width": 200, "height": 140 },
  "rotation": 0,
  "metadata": {
    "material": "fabric", 
    "color": "#B5651D",
    "label": "Двуспальная кровать",
    "room_types": ["спальня"]
  }
}
```

### Угловой диван
```json
{
  "type": "sofa", 
  "subtype": "corner",
  "position": { "x": 0, "y": 0 },
  "size": { "width": 240, "height": 180 },
  "rotation": 0,
  "metadata": {
    "seats": 5,
    "material": "fabric",
    "color": "#8B4513",
    "label": "Угловой диван",
    "room_types": ["гостиная", "зал"]
  }
}
```

### Кухонный гарнитур
```json
{
  "type": "kitchen",
  "subtype": "l_shape",
  "modules": [
    {
      "type": "counter",
      "position": { "x": 0, "y": 0 },
      "size": { "width": 200, "height": 60 },
      "rotation": 0
    },
    {
      "type": "sink_cabinet",
      "position": { "x": 0, "y": 0 },
      "size": { "width": 80, "height": 60 },
      "rotation": 0
    }
  ],
  "metadata": {
    "countertop_material": "quartz",
    "color_scheme": { 
      "cabinets": "#EEE8AA", 
      "countertop": "#FFFFFF" 
    },
    "label": "Г-образная кухня",
    "room_types": ["кухня"]
  }
}
```

## Как это работает

### 1. Анализ по типу помещения
Система автоматически определяет, какую мебель искать в зависимости от названия комнаты:
- **Спальня**: кровати, шкафы, комоды, прикроватные тумбы
- **Кухня**: гарнитуры, техника, столы, стулья
- **Ванная**: сантехника, стиральная машина, шкафчики
- **Гостиная**: диваны, кресла, столики, ТВ-тумбы

### 2. Точное позиционирование
- GPT получает координаты помещения из конструктора
- Анализирует расположение стен на фотографиях
- Размещает мебель с учетом дверей и окон
- Возвращает координаты в диапазоне 0.0-1.0 относительно помещения

### 3. Валидация результатов
- Проверка на соответствие типов мебели базе данных
- Контроль размеров и позиций объектов
- Автоматическая коррекция некорректных данных

## Использование в коде

```javascript
// Получить все типы мебели
const allTypes = getAllFurnitureTypes();

// Получить мебель для конкретного типа помещения
const kitchenFurniture = getFurnitureByRoomType('кухня');

// Сгенерировать инструкции для GPT
const instructions = generateFurnitureInstructions('спальня');

// Анализ с данными макета
const result = await analyzeRoomVision({
  photoBuffers: photos,
  key: 'room1',
  name: 'Спальня',
  sqm: 15,
  layoutData: {
    x: 0.1, y: 0.2, width: 0.3, height: 0.4,
    doors: [{ side: 'left', pos: 0.5, len: 0.2 }],
    windows: [{ side: 'top', pos: 0.3, len: 0.3 }]
  }
});
```

## Преимущества новой системы

1. **Точность**: Строгий контроль типов мебели исключает ложные срабатывания
2. **Гибкость**: Легко добавлять новые типы мебели в базу данных
3. **Контекст**: Анализ учитывает тип помещения и его геометрию
4. **Надежность**: Система не создает объекты "из воздуха"
5. **Масштабируемость**: Поддержка различных стилей и вариантов мебели

## Результат

Теперь GPT анализирует фотографии более осознанно, опираясь на четкие определения мебели и геометрию помещения из конструктора. Это обеспечивает более точные и предсказуемые результаты анализа.
