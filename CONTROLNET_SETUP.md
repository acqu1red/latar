# Установка ControlNet для локальной генерации

## Обзор

Мы интегрировали ControlNet для полной независимости от внешних API и кредитов. ControlNet позволяет генерировать планы квартир с мебелью локально на вашем сервере.

## Преимущества ControlNet

- ✅ **Полная независимость** - никаких внешних API и кредитов
- ✅ **Локальная генерация** - все работает на вашем сервере
- ✅ **Точный контроль** - ControlNet лучше сохраняет детали планов
- ✅ **Мебель по типу помещения** - автоматически добавляет подходящую мебель
- ✅ **Открытый код** - полный контроль над процессом

## Требования

### Системные требования
- Python 3.8+ 
- Node.js 16+
- Минимум 8GB RAM (рекомендуется 16GB+)
- GPU с 4GB+ VRAM (опционально, но рекомендуется)

### Python зависимости
- PyTorch
- Diffusers
- Transformers
- ControlNet-aux
- OpenCV
- Pillow

## Установка

### 1. Установка Python зависимостей

```bash
cd backend
python install-controlnet.py
```

Или вручную:
```bash
pip install torch torchvision diffusers transformers accelerate controlnet-aux opencv-python Pillow numpy scipy matplotlib tqdm
```

### 2. Установка Node.js зависимостей

```bash
cd backend
npm install
```

### 3. Запуск сервера

```bash
npm start
```

## Как это работает

### 1. Анализ помещения
- Система анализирует загруженное изображение плана
- Определяет тип помещения (спальня, кухня, ванная, гостиная)
- Выбирает подходящую мебель из базы данных

### 2. Генерация эскиза
- Создается черно-белый эскиз из исходного изображения
- Эскиз используется как контроль для ControlNet

### 3. Генерация с мебелью
- ControlNet генерирует новый план с мебелью
- Мебель размещается логично в соответствии с типом помещения
- План центрируется и сохраняет все пропорции

## Типы помещений и мебель

### Спальня
- Кровать, комод, шкаф, тумба, зеркало

### Кухня  
- Холодильник, плита, раковина, кухонный гарнитур, микроволновка

### Ванная
- Ванна/душ, раковина, туалет, зеркало

### Гостиная
- Диван, кресло, телевизор, стол, книжный шкаф

### Туалет
- Унитаз, раковина, зеркало

## API Endpoints

### POST /api/generate-photo
Генерирует простой план без мебели

### POST /api/generate-with-furniture  
Генерирует план с мебелью (новый функционал)

## Настройка производительности

### Для GPU (рекомендуется)
```python
# В controlNetGenerator.mjs
pipe = pipe.to("cuda")
```

### Для CPU
```python
# В controlNetGenerator.mjs  
pipe = pipe.to("cpu")
```

## Устранение неполадок

### Ошибка "Python не найден"
Установите Python 3.8+ и добавьте в PATH

### Ошибка "CUDA out of memory"
Уменьшите размер изображения или используйте CPU

### Медленная генерация на CPU
- Увеличьте RAM
- Используйте GPU если доступен
- Уменьшите количество шагов генерации

## Модели ControlNet

Используемые модели:
- `lllyasviel/sd-controlnet-scribble` - для эскизов
- `runwayml/stable-diffusion-v1-5` - базовая модель

Модели загружаются автоматически при первом запуске.

## Мониторинг

Проверьте логи сервера для отслеживания:
- Загрузки моделей
- Процесса генерации
- Ошибок и предупреждений

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Убедитесь что все зависимости установлены
3. Проверьте доступность GPU/RAM
4. Обратитесь к документации ControlNet
