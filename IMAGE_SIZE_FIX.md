# Исправление ошибки "array too long" для больших изображений

## Проблема
OpenAI API `gpt-image-1` через `images.edit` имеет жёсткое ограничение:
```
Invalid 'image': array too long. Expected an array with maximum length 16384, but got an array with length 221828 instead.
```

API принимает только изображения размером до **16,384 байт** (16 КБ), что крайне мало для качественных изображений планов.

## Решение: Публичные URL

### 1. Создан статический маршрут для временных изображений
```javascript
// В server.mjs
app.use('/temp-images', express.static(path.join(__dirname, 'uploads')));
```

### 2. Обновлена функция analyzeImageWithGPT
- Сжимает изображение до 768×768 пикселей
- Сохраняет во временный файл в папке uploads
- Создаёт публичный URL: `{baseUrl}/temp-images/{filename}`
- Передаёт URL в API вместо Buffer
- Автоматически удаляет временный файл после обработки

### 3. Добавлена переменная окружения BASE_URL
```bash
# Для локальной разработки
BASE_URL=http://localhost:3001

# Для продакшена
BASE_URL=https://your-domain.com
```

## Преимущества решения

✅ **Обходит ограничение API** - можно передавать изображения любого размера  
✅ **Экономия памяти** - не храним большие Buffer в памяти  
✅ **Автоматическая очистка** - временные файлы удаляются после обработки  
✅ **Безопасность** - уникальные имена файлов предотвращают конфликты  
✅ **Масштабируемость** - работает как локально, так и на сервере  

## Логи процесса

```
Сжимаем изображение для экономии памяти...
Размер исходного изображения: 2048576 байт
Сжатие завершено. Экономия памяти: 89%
Размер сжатого изображения: 221828 байт
Временный файл создан: temp-1703123456789-abc123def.png
Публичный URL изображения: http://localhost:3001/temp-images/temp-1703123456789-abc123def.png
GPT Image генерация завершена
Временный файл удален: temp-1703123456789-abc123def.png
```

## Использование

```bash
# Запуск сервера
npm start

# Сервер автоматически:
# 1. Сжимает загруженные изображения
# 2. Создаёт публичные URL
# 3. Передаёт URL в OpenAI API
# 4. Удаляет временные файлы
```

## Настройка для продакшена

В файле `.env` установите правильный BASE_URL:
```bash
BASE_URL=https://your-render-app.onrender.com
```

Это обеспечит корректную работу публичных ссылок на изображения.
