# Деплой на Timeweb

## Настройка приложения

**Команда сборки:**
```bash
cd backend && npm install --only=production
```

**Зависимости:**
- Node.js 20+ (обязательно!)
- npm

**Команда запуска:**
```bash
cd backend && node server.mjs
```

**Важно:** 
- Timeweb использует Node.js v12 по умолчанию, но нам нужен Node.js 20+ для работы с Sharp
- API ключ Scribble Diffusion обязателен! Без него приложение не запустится
- Убедитесь, что в настройках приложения указана версия Node.js 20+

## Переменные окружения (Environment Variables)

В панели Timeweb добавьте следующие переменные:

```env
NODE_ENV=production
PORT=3001
SCRIBBLE_DIFFUSION_API_KEY=ваш_scribble_diffusion_api_ключ_здесь
```

## Инструкции по деплою

### Вариант 1: Через Git (рекомендуется)

1. **Подключите репозиторий:**
   - В панели Timeweb выберите "Создать приложение"
   - Выберите "Git репозиторий"
   - Укажите URL вашего репозитория: `https://github.com/acqu1red/latar`

2. **Настройте сборку:**
   - **Корневая папка:** `backend`
   - **Команда сборки:** `npm install --only=production`
   - **Команда запуска:** `npm start`

3. **Добавьте переменные окружения:**
   - `NODE_ENV=production`
   - `PORT=3001`
   - `SCRIBBLE_DIFFUSION_API_KEY=ваш_ключ_здесь`

### Вариант 2: Через Docker

1. **Создайте Dockerfile** (уже создан в корне проекта)
2. **Подключите репозиторий** с Dockerfile
3. **Настройте переменные окружения** как указано выше

### Вариант 3: Загрузка архива

1. **Создайте архив** с содержимым папки `backend`
2. **Загрузите архив** в Timeweb
3. **Настройте переменные окружения**

## Проверка работы

После деплоя проверьте:

1. **Health check:** `https://your-app.timeweb.cloud/healthz`
2. **API endpoint:** `https://your-app.timeweb.cloud/api/generate-photo`

## Особенности Timeweb

- **Порт:** Timeweb автоматически назначает порт, используйте `process.env.PORT`
- **Память:** Рекомендуется минимум 512MB для обработки изображений
- **Таймаут:** Установите таймаут не менее 60 секунд для генерации
- **Логи:** Проверяйте логи в панели Timeweb для отладки

## Troubleshooting

**Ошибка "Unsupported engine" (Node.js v12):**
- В настройках приложения Timeweb установите Node.js версии 20+
- Или используйте Dockerfile.timeweb для принудительной установки Node.js 20

**Ошибка "exec: cd: executable file not found":**
- Используйте команду запуска: `node server.mjs` вместо `npm start`
- Убедитесь, что рабочая директория установлена как `backend`

**Ошибка "Module not found":**
- Убедитесь, что корневая папка установлена как `backend`
- Проверьте, что все зависимости установлены

**Ошибка "Port already in use":**
- Убедитесь, что используется `process.env.PORT` вместо фиксированного порта

**Ошибка "Memory limit exceeded":**
- Увеличьте лимит памяти в настройках приложения до 1024MB
- Оптимизируйте обработку изображений

**Ошибка "API key not found":**
- Проверьте, что переменная `SCRIBBLE_DIFFUSION_API_KEY` установлена
- API ключ обязателен! Без него приложение не запустится
