# Обновление: Локальная генерация изображений

## Проблема
Ошибка 422 при использовании Replicate API: "Invalid version or not permitted" - указанная версия модели недоступна или нет прав на её использование.

## Решение
Добавлена локальная генерация изображений как fallback для ScribbleDiffusion. Теперь система работает в двух режимах:

### 1. Replicate API (если настроен)
- Использует актуальную модель ControlNet Scribble
- Высокое качество генерации
- Требует API токен

### 2. Локальная генерация (всегда доступна)
- Не требует внешних API
- Работает на основе алгоритмов обработки изображений
- Автоматически активируется при ошибках API

## Новые возможности

### Улучшенные алгоритмы
- **Улучшенное создание эскизов**: Морфологические операции для лучшего качества линий
- **Цветовые схемы**: Автоматический выбор цветов на основе промпта
- **Градиентные фоны**: Создание красивых фоновых градиентов
- **Маскирование**: Применение эскиза как маски к цветному изображению

### Поддерживаемые стили
- **Закаты/рассветы**: Оранжево-желтая палитра
- **Океан/вода**: Сине-голубая палитра  
- **Лес/природа**: Зеленая палитра
- **Интерьеры/комнаты**: Коричнево-бежевая палитра
- **Дефолт**: Сине-розовая палитра

## Как это работает

1. **Загрузка изображения** → Создание улучшенного эскиза
2. **Анализ промпта** → Определение цветовой схемы
3. **Создание градиента** → Базовое цветное изображение
4. **Применение маски** → Наложение эскиза на градиент
5. **Финальная обработка** → Получение результата

## Преимущества

✅ **Надежность**: Работает без внешних API  
✅ **Скорость**: Мгновенная генерация  
✅ **Бесплатность**: Не требует оплаты API  
✅ **Качество**: Хорошие результаты для большинства случаев  
✅ **Fallback**: Автоматическое переключение при ошибках API  

## Тестирование

Запустите тест локальной генерации:
```bash
node test-local-generation.mjs
```

## Развертывание

Система готова к развертыванию на Koyeb без дополнительных настроек. Replicate API токен опционален.

## Результат

Теперь генерация фотографий работает в любом случае:
- С Replicate API токеном: высокое качество через API
- Без токена: локальная генерация с хорошим качеством
- При ошибках API: автоматический fallback на локальную генерацию
