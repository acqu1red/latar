# Исправление ошибки 404 при загрузке изображений по URL

## Проблема

При локальной разработке возникала ошибка 404 при попытке загрузить изображение по URL:

```
Ошибка загрузки изображения по URL: Error: HTTP error! status: 404
```

**Причина**: Публичный URL `https://acqu1red.github.io/latar/temp-images/` недоступен в локальной среде разработки.

## Решение

### 1. Исправлен baseUrl для локальной разработки

```javascript
// В server.mjs
const baseUrl = process.env.BASE_URL || `http://localhost:${PORT}`;
```

- **Локальная разработка**: `http://localhost:8000`
- **Продакшен**: `https://acqu1red.github.io/latar` (через переменную окружения)

### 2. Добавлен fallback на прямое использование Buffer

Если GitHub не настроен, система теперь использует сжатое изображение напрямую:

```javascript
if (isGitHubConfigured()) {
  // Загружаем на GitHub и используем URL
} else {
  // Используем сжатое изображение напрямую
  imageUrl = null;
  cleanupData = {
    type: 'direct',
    buffer: compressedImageBuffer
  };
}
```

### 3. Умная обработка изображений

```javascript
if (imageUrl) {
  try {
    // Пытаемся загрузить по URL
    const downloadedImageBase64 = await downloadImageAsBase64(imageUrl);
    imageBuffer = Buffer.from(downloadedImageBase64, 'base64');
  } catch (urlError) {
    // Fallback на локальный файл или пересжатие
  }
} else {
  // Используем сжатое изображение напрямую
  imageBuffer = cleanupData.buffer;
}
```

## Преимущества решения

✅ **Надёжность** - работает в любой среде (локальной и продакшен)  
✅ **Производительность** - избегает ненужных HTTP запросов в локальной среде  
✅ **Экономия памяти** - использует сжатые изображения напрямую  
✅ **Fallback система** - автоматически переключается при ошибках  

## Логика работы

### С GitHub токеном:
1. Сжимает изображение
2. Загружает на GitHub
3. Получает публичный URL
4. Загружает изображение по URL
5. Передает в API

### Без GitHub токена:
1. Сжимает изображение
2. Использует Buffer напрямую
3. Передает в API

### При ошибке URL:
1. Пытается загрузить по URL
2. При ошибке 404 переключается на fallback
3. Использует локальный файл или пересжимает

## Мониторинг

В логах отображается:

```
Сжимаем изображение для экономии памяти...
Размер исходного изображения: 1794879 байт
Сжатие завершено. Экономия памяти: 88%
Размер сжатого изображения: 221828 байт
GitHub не настроен, используем прямое сжатое изображение
Публичный URL изображения: null
GPT Image генерация завершена
Очистка не требуется для прямого использования Buffer
```

## Настройка для разных сред

### Локальная разработка
```bash
# .env файл не нужен, используется localhost
BASE_URL=http://localhost:8000
```

### Продакшен с GitHub
```bash
# .env файл
GITHUB_TOKEN=ghp_your-token-here
BASE_URL=https://acqu1red.github.io/latar
```

### Продакшен без GitHub
```bash
# .env файл
BASE_URL=https://your-domain.com
# GITHUB_TOKEN не установлен
```

## Устранение неполадок

### Ошибка 404 при загрузке по URL
- **Решение**: Система автоматически переключится на fallback
- **Проверка**: Убедитесь, что baseUrl корректный для вашей среды

### Ошибка "GitHub токен не настроен"
- **Решение**: Это нормально для локальной разработки
- **Альтернатива**: Настройте GitHub токен для использования URL

### Высокое потребление памяти
- **Решение**: Система использует сжатые изображения (768×768)
- **Оптимизация**: Увеличьте лимит памяти Node.js до 4GB
