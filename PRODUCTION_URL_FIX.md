# Исправление ошибки "Error while downloading" в продакшене

## Проблема

В продакшене на [https://acqu1red.github.io/latar/](https://acqu1red.github.io/latar/) возникала ошибка:

```
Error while downloading http://localhost:8000/temp-images/temp-1758112995660-70igowvcs.png.
```

**Причина**: baseUrl по умолчанию был установлен на `http://localhost:8000`, но в продакшене нужно использовать GitHub Pages URL.

## Решение

### 1. Исправлен baseUrl по умолчанию

```javascript
// В server.mjs
const baseUrl = process.env.BASE_URL || 'https://acqu1red.github.io/latar';
```

**Было**: `http://localhost:8000` (локальная разработка)  
**Стало**: `https://acqu1red.github.io/latar` (продакшен)

### 2. Обновлены переменные окружения

```bash
# .env файл
BASE_URL=https://acqu1red.github.io/latar
```

### 3. Добавлены предупреждения для продакшена

```javascript
if (baseUrl.includes('github.io')) {
  console.warn('⚠️ ВНИМАНИЕ: GitHub не настроен, но используется продакшен URL');
  console.warn('Это может привести к ошибкам загрузки изображений');
  console.warn('Рекомендуется настроить GITHUB_TOKEN для стабильной работы');
}
```

## Настройка для разных сред

### Продакшен (по умолчанию)
```bash
# .env файл
BASE_URL=https://acqu1red.github.io/latar
GITHUB_TOKEN=your_github_token_here  # Рекомендуется для стабильности
```

### Локальная разработка
```bash
# .env файл
BASE_URL=http://localhost:8000
# GITHUB_TOKEN не обязателен для локальной разработки
```

## Процесс работы

### С GitHub токеном (рекомендуется)
```
Сжимаем изображение для экономии памяти...
Размер исходного изображения: 1794879 байт
Сжатие завершено. Размер сжатого изображения: 834587 байт
Экономия памяти: 54%
Используем GitHub для загрузки изображения
Загружаем изображение на GitHub: temp-1758112995660-abc123def.png
Изображение успешно загружено на GitHub: https://raw.githubusercontent.com/acqu1red/latar/main/temp-images/temp-1758112995660-abc123def.png
Публичный URL изображения: https://raw.githubusercontent.com/acqu1red/latar/main/temp-images/temp-1758112995660-abc123def.png
GPT-4o mini генерация завершена
```

### Без GitHub токена (fallback)
```
Сжимаем изображение для экономии памяти...
Размер исходного изображения: 1794879 байт
Сжатие завершено. Размер сжатого изображения: 834587 байт
Экономия памяти: 54%
GitHub не настроен, используем локальную загрузку
⚠️ ВНИМАНИЕ: GitHub не настроен, но используется продакшен URL
Это может привести к ошибкам загрузки изображений
Рекомендуется настроить GITHUB_TOKEN для стабильной работы
Временный файл создан: temp-1758112995660-70igowvcs.png
Публичный URL изображения: https://acqu1red.github.io/latar/temp-images/temp-1758112995660-70igowvcs.png
```

## Преимущества решения

✅ **Правильный URL для продакшена** - использует GitHub Pages URL  
✅ **Предупреждения** - уведомляет о потенциальных проблемах  
✅ **Fallback система** - работает даже без GitHub токена  
✅ **Гибкость** - можно настроить для разных сред  

## Рекомендации

### Для продакшена
1. **Настройте GitHub токен** - для стабильной работы
2. **Используйте GitHub Pages URL** - `https://acqu1red.github.io/latar`
3. **Мониторьте логи** - следите за предупреждениями

### Для локальной разработки
1. **Используйте localhost URL** - `http://localhost:8000`
2. **GitHub токен не обязателен** - можно тестировать без него
3. **Проверяйте baseUrl** - убедитесь, что используется правильный URL

## Устранение неполадок

### Ошибка "Error while downloading"
- **Причина**: Неправильный baseUrl или недоступный URL
- **Решение**: Проверьте BASE_URL в переменных окружения

### Ошибка "GitHub не настроен"
- **Причина**: GITHUB_TOKEN не установлен
- **Решение**: Настройте GitHub токен или используйте локальную разработку

### Ошибка "Временный файл не найден"
- **Причина**: Файл не создан или удален
- **Решение**: Проверьте права доступа к папке uploads

## Мониторинг

### Успешная работа
```
Base URL для публичных ссылок: https://acqu1red.github.io/latar
Используем GitHub для загрузки изображения
Изображение успешно загружено на GitHub: https://raw.githubusercontent.com/acqu1red/latar/main/temp-images/temp-1758112995660-abc123def.png
GPT-4o mini генерация завершена
```

### Предупреждения
```
⚠️ ВНИМАНИЕ: GitHub не настроен, но используется продакшен URL
Это может привести к ошибкам загрузки изображений
Рекомендуется настроить GITHUB_TOKEN для стабильной работы
```

## Связанные исправления

- **Responses API миграция** - переход на GPT-4o mini
- **GitHub интеграция** - загрузка изображений на GitHub
- **Память оптимизация** - сжатие изображений
