# Интеграция с GitHub для загрузки временных изображений

## Обзор

Вместо использования локального сервера для временных изображений, теперь приложение использует GitHub для хранения и предоставления публичных URL изображений. Это решает проблему ограничения размера изображений в OpenAI API.

## Настройка

### 1. Создание GitHub Personal Access Token

1. Перейдите на [GitHub Settings > Personal Access Tokens](https://github.com/settings/tokens)
2. Нажмите "Generate new token (classic)"
3. Выберите права доступа:
   - ✅ **repo** (полный доступ к репозиторию)
   - ✅ **public_repo** (доступ к публичным репозиториям)
4. Скопируйте созданный токен (начинается с `ghp_`)

### 2. Настройка переменных окружения

Создайте файл `.env` в папке `backend/`:

```bash
# OpenAI API Configuration
OPENAI_API_KEY=sk-proj-your-openai-key-here

# GitHub Configuration
GITHUB_TOKEN=ghp_your-github-token-here

# Base URL для публичных ссылок
BASE_URL=https://acqu1red.github.io/latar
```

### 3. Автоматическая настройка

Запустите скрипт настройки:

```bash
cd backend
npm run setup
```

## Как это работает

### Процесс обработки изображения:

1. **Сжатие**: Изображение сжимается до 768×768 пикселей
2. **Загрузка на GitHub**: Создается коммит с изображением в папку `temp-images/`
3. **Публичный URL**: `https://raw.githubusercontent.com/acqu1red/latar/main/temp-images/temp-{timestamp}-{random}.png`
4. **API вызов**: OpenAI API получает публичный URL вместо Buffer
5. **Очистка**: Временный файл удаляется с GitHub после обработки

### Fallback на локальную загрузку

Если GitHub токен не настроен, система автоматически переключается на локальную загрузку файлов.

## Преимущества

✅ **Обходит ограничения API** - можно передавать изображения любого размера  
✅ **Надёжность** - GitHub обеспечивает стабильную доступность файлов  
✅ **Автоматическая очистка** - временные файлы удаляются после обработки  
✅ **Безопасность** - уникальные имена файлов предотвращают конфликты  
✅ **Масштабируемость** - работает в любой среде без настройки файлового сервера  

## Структура репозитория

```
latar/
├── temp-images/          # Временные изображения (автоматически создается)
│   ├── temp-1703123456789-abc123def.png
│   └── temp-1703123456790-def456ghi.png
├── frontend/
├── backend/
└── ...
```

## Мониторинг

В логах отображается:

```
Сжимаем изображение для экономии памяти...
Размер исходного изображения: 2048576 байт
Сжатие завершено. Экономия памяти: 89%
Размер сжатого изображения: 221828 байт
Используем GitHub для загрузки изображения
Загружаем изображение на GitHub: temp-1703123456789-abc123def.png
Изображение успешно загружено на GitHub: https://raw.githubusercontent.com/acqu1red/latar/main/temp-images/temp-1703123456789-abc123def.png
GitHub commit SHA: abc123def456...
Публичный URL изображения: https://raw.githubusercontent.com/acqu1red/latar/main/temp-images/temp-1703123456789-abc123def.png
GPT Image генерация завершена
Удаляем временный файл с GitHub: temp-images/temp-1703123456789-abc123def.png
Изображение успешно удалено с GitHub: temp-images/temp-1703123456789-abc123def.png
```

## Устранение неполадок

### Ошибка "GitHub токен не настроен"
- Проверьте, что `GITHUB_TOKEN` установлен в `.env`
- Убедитесь, что токен имеет права `repo`

### Ошибка "Resource not accessible by integration"
- Проверьте права токена
- Убедитесь, что токен не истёк

### Ошибка "Repository not found"
- Проверьте, что репозиторий `acqu1red/latar` существует
- Убедитесь, что токен имеет доступ к репозиторию

## Безопасность

- GitHub токен хранится в переменных окружения
- Временные файлы автоматически удаляются
- Уникальные имена файлов предотвращают конфликты
- Токен имеет минимально необходимые права доступа
