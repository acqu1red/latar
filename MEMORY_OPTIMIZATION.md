# Оптимизация памяти для обработки изображений

## Проблема
При обработке больших изображений (1024×1024 PNG) возникала ошибка:
```
FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory
```

## Решения

### 1. Сжатие изображений с помощью Sharp
- Установлена библиотека `sharp` для эффективного сжатия изображений
- Изображения сжимаются до 768×768 пикселей перед отправкой в API
- Используется оптимизированное сжатие PNG с качеством 90%

### 2. Увеличение лимита памяти Node.js
- Обновлены скрипты запуска: `--max-old-space-size=4096` (4GB RAM)
- Обновлен Procfile для деплоя на Render
- Обновлены dev и production скрипты

### 3. Оптимизация использования Buffer
- Убрана избыточная конвертация base64 в Buffer
- Добавлено освобождение памяти после обработки (`buffer.fill(0)`)
- Минимизировано дублирование данных в памяти

## Результат
- Экономия памяти до 60-80% при сжатии изображений
- Увеличенный лимит памяти до 4GB
- Более эффективное использование ресурсов

## Использование
```bash
# Запуск с оптимизацией памяти
npm start

# Разработка с оптимизацией памяти
npm run dev
```

## Мониторинг
В логах отображается:
- Размер исходного изображения
- Размер сжатого изображения  
- Процент экономии памяти
- Размер base64 результата
